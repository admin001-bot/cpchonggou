input {
  # 文件输入 - 后端应用日志
  file {
    path => "/logs/backend/*.log"
    start_position => "beginning"
    sincedb_path => "/dev/null"
    codec => "json"
    type => "backend"
  }

  # Beats 输入
  beats {
    port => 5044
    type => "beats"
  }

  # TCP 输入（用于应用程序直接发送日志）
  tcp {
    port => 5000
    codec => json_lines
    type => "tcp"
  }
}

filter {
  # 解析日志级别
  if [level] {
    mutate {
      add_field => { "log_level" => "%{level}" }
    }
  }

  # 解析时间戳
  if [timestamp] {
    date {
      match => ["timestamp", "ISO8601"]
      target => "@timestamp"
    }
  }

  # 添加环境标签
  mutate {
    add_field => {
      "environment" => "production"
      "service" => "lottery"
    }
  }

  # 解析用户相关字段
  if [user_id] {
    mutate {
      add_field => { "user_id" => "%{user_id}" }
    }
  }

  # IP 地址 GeoIP 解析（可选）
  if [client_ip] {
    mutate {
      copy => { "client_ip" => "ip" }
    }
  }

  # 删除不必要的字段
  mutate {
    remove_field => ["@version", "path", "host", "tags"]
  }
}

output {
  # 输出到 Elasticsearch
  elasticsearch {
    hosts => ["http://elasticsearch:9200"]
    index => "lottery-logs-%{+YYYY.MM.dd}"
    template_name => "lottery-logs"
    template_overwrite => true
    ilm_enabled => false
  }

  # 同时输出到控制台（用于调试）
  stdout {
    codec => rubydebug
  }

  # 错误日志单独处理
  if [log_level] == "ERROR" or [log_level] == "FATAL" {
    elasticsearch {
      hosts => ["http://elasticsearch:9200"]
      index => "lottery-errors-%{+YYYY.MM.dd}"
    }
  }
}
